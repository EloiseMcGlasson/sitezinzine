{% extends 'admin/admin.html.twig' %}
{% block title %}
    Grille de programmation
{% endblock %}
{% block stylesheets %}
    {{ parent() }}
    <style>
.grid-table {
    border-collapse: collapse;
    width: 100%;
}

.grille-wrapper {
    flex: 1;
    overflow-x: auto;
}

.grid-table th, .grid-table td {
    border: 1px solid #ccc;
    text-align: center;
    height: 8px;
    font-size: 12px;
}

.grid-table td {
    overflow: hidden;
    max-width: 150px; /* ou la largeur que tu souhaites */
    position: relative; /* pour que .emission-block absolute reste dans la cellule */
}

.grid-table thead th {
    padding: 8px;
    background-color: #f5f5f5;
    font-size: 14px;
    text-align: center;
    vertical-align: middle;
    height: 60px;
}

.grid-table thead th > div {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100%;
    line-height: 1.2;
}

.grid-table thead th div:first-child {
    font-size: 16px;
    font-weight: bold;
    margin-bottom: 4px;
}

.grid-table thead th div:last-child {
    font-size: 14px;
    color: #555;
}

.heure-cell {
    font-weight: bold;
    font-size: 14px;
    text-align: center;
    vertical-align: middle;
    background-color: #fff;
}

.dropzone {
    background-color: #fff;
    height: 30px;
    position: relative;
    padding: 0;
    overflow: visible;
}

.dropzone.drag-over {
    background-color: #ffecec;
    border: 2px dashed #E4013A;
}

.dropzone.occupied {
    background-image: repeating-linear-gradient(
        45deg,
        #e4013a 0,
        #e4013a 3px,
        white 3px,
        white 6px
    );
    background-size: 10px 10px;
    cursor: not-allowed;
}

.emission-block {
    background-color: #E4013A;
    color: white;
    padding: 4px 6px;
    border-radius: 4px;
    font-size: 12px;
    cursor: grab;
    user-select: none;
    box-sizing: border-box;
    height: 100%;
}

.emission-block.in-grid {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    box-sizing: border-box;
    background-color: #E4013A;
    color: white;
    padding: 4px 6px;
    border-radius: 4px;
    font-size: 12px;
    cursor: grab;
    z-index: 1;
    white-space: normal;       /* Permet le retour Ã  la ligne */
    overflow: hidden;          /* Cache ce qui dÃ©passe */
    text-overflow: ellipsis;   /* Ajoute "..." si trop long */
    word-wrap: break-word;     /* Coupe les mots trop longs */
    max-width: 100%;           /* Ne dÃ©passe pas la cellule */
    box-sizing: border-box;    /* Inclut padding dans la largeur */
}



.emission-block.in-use {
    opacity: 0.5;
    cursor: not-allowed;
}

#emissions-pool.drop-pool-hover {
    background-color: #fff8f8;
    border: 2px dashed #E4013A;
    padding: 10px;
    border-radius: 6px;
    transition: background-color 0.2s ease;
}

.emissions-wrapper h2 {
    font-size: 16px;
    color: white;
    margin: 0;
}

.emission-wrapper {
    pointer-events: none;
    padding: 0;
    margin: 0;
    box-sizing: border-box;
}
.emission-wrapper .emission-block {
    pointer-events: auto;
}

.rowgroup-even td {
    background-color: #ffffff;
}

.rowgroup-odd td {
    background-color: #f2f2f2;
}

.custom-tooltip {
  position: fixed;
    display: none;
    background: rgba(0, 0, 0, 0.85);
    color: white;
    padding: 4px 8px;
    font-size: 12px;
    border-radius: 4px;
    pointer-events: none;
    z-index: 9999;
    max-width: 300px; /* Tu peux ajuster si tu veux une limite douce */
    white-space: normal;
    overflow: visible;
    text-overflow: unset;
    word-wrap: break-word;
}


</style>
{% endblock %}
{% block body %}
    <h1>
        Grille de programmation
    </h1>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <a href="{{ path('admin.grille.index', {'startOfWeek': startOfWeek|date_modify('-7 days')|date('Y-m-d')}) }}">
            â¬… Semaine prÃ©cÃ©dente
        </a>
        <h2 style="color:white; font-size: 18px; margin: 0;">
            <a href="{{ path('admin.grille.index') }}">
                ðŸ“… Semaine actuelle
            </a>
            Semaine du
            {{ startOfWeek|date('d/m/Y') }}
        </h2>
        <a href="{{ path('admin.grille.index', {'startOfWeek': startOfWeek|date_modify('+7 days')|date('Y-m-d')}) }}">
            Semaine suivante âž¡
        </a>
    </div>
    <div data-controller="grid" style="display: flex; gap: 30px;">
        {# âž¤ Grille principale #}
        <div class="grille-wrapper">
            <table class="grid-table">
                <thead>
                    <tr>
                        <th>
                            Heure
                        </th>
                        {% set jours = [] %}
                        {% for i in 0..6 %}
                            {% set jours = jours|merge([startOfWeek|date_modify("+" ~ i ~ " days")]) %}
                        {% endfor %}
                        {% for jour in jours %}
                            <th>
                                {{ jour|format_date('medium', locale='fr') }}
                            </th>
                        {% endfor %}
                    </tr>
                    
                </thead>
         <tbody>
    {% for row in displayRows %}
    <tr>
        {% set td_count = 0 %}
        {% for dayIndex in 0..6 %}
            {% set slot = row.slots[dayIndex] %}
            {% if slot.type == 'emission' %}
                <td colspan="{{ slot.colspan }}">
                    {{ slot.diffusion.emission.titre }}
                </td>
                {% set td_count = td_count + slot.colspan %}
            {% elseif slot.type == 'empty' %}
                <td></td>
                {% set td_count = td_count + 1 %}
            {% else %}
                {# covered => ne rien afficher, ne pas compter #}
            {% endif %}
        {% endfor %}
        <td colspan="{{ 7 - td_count }}" style="color:black;">Cols: {{ td_count }}</td>
    </tr>


        <tr class="{{ cycle(['rowgroup-even', 'rowgroup-odd'], loop.index0) }}">
            {% if row.quarter == 0 %}
                <td class="heure-cell" rowspan="4">{{ "%02d:00"|format(row.hour) }}</td>
            {% endif %}

            {% for dayIndex in 0..6 %}
                {% set slot = row.slots[dayIndex] %}

                {% if slot.type == 'emission' %}
                    <td class="dropzone" colspan="{{ slot.colspan }}">
                        <div class="emission-block in-grid">
                            ðŸŽ™ {{ slot.diffusion.emission.titre }}<br>
                            {{ slot.diffusion.emission.duree }} min
                        </div>
                    </td>
                {% elseif slot.type == 'empty' %}
                    {% set date = jours[dayIndex]|date_modify(row.hour ~ ' hour')|date_modify((row.quarter * 15) ~ ' minutes') %}
                    <td class="dropzone"
                        data-date="{{ date|date('Y-m-d H:i:00') }}"
                        data-day="{{ dayIndex }}"
                        data-hour="{{ row.hour }}"
                        data-quarter="{{ row.quarter }}">
                    </td>
                {% endif %}
                {# covered: on ne rend rien #}
            {% endfor %}
        </tr>
    {% endfor %}
</tbody>


                </table>
            </div>
            {# âž¤ Colonne de droite : Ã‰missions disponibles #}
            <div class="emissions-wrapper">
                <h2 style="font-size: 16px;">
                    Ã‰missions disponibles
                </h2>
                <div id="emissions-pool" style="display: flex; flex-direction: column; gap: 10px;">{# {% for emission in emissions %}
                    <div data-grid-target="emission" class="emission-block" draggable="true" data-id="{{ emission.id }}" data-duration="{{ emission.duree }}">
                    ðŸŽ™ {{ emission.titre }} ({{ emission.duree }} min)
                    </div>
                    {% else %}
                    <div>Aucune Ã©mission disponible</div>
                {% endfor %} #}
                </div>
            </div>
        </div>
        <div id="tooltip" class="custom-tooltip"></div>
    {% endblock %}
    