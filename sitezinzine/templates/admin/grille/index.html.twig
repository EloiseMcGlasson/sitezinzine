{% extends 'admin/admin.html.twig' %}
{% block title %}
  Grille de programmation
{% endblock %}
{% block stylesheets %}
  {{ parent() }}
  <style>
  :root{
    --slot-h: 8px;               /* 1 quart dâ€™heure = 8px */
    --head-h: 44px;              /* hauteur de lâ€™en-tÃªte */
    --grid-bg:#fff;
    --grid-line:#e6e6e6;
    --head-bg:#f0f0f0;
    --head-text:#1c1c1a;
    --hour-text:#3a3a3a;

    /* Post-it plus neutre */
    --postit:#d75a6f;            /* rouge adouci */
    --postit-border:#b9475a;
    --postit-text:#fff;
  }

  .schedule-layout{display:flex;gap:24px;align-items:flex-start}
  .grid-area{flex:1;min-width:0}
  .sidebar{width:320px;flex:0 0 320px}

  /* Grille unique : 1 ligne dâ€™en-tÃªte + 96 lignes de slots */
  .schedule-grid{
    display:grid;
    grid-template-columns: 80px repeat(7, 1fr);
    grid-template-rows: var(--head-h) repeat(96, var(--slot-h));
    border-left:1px solid var(--grid-line);
    border-right:1px solid var(--grid-line);
    background:var(--grid-bg);
  }

  /* En-tÃªtes */
  .head{
    display:flex;align-items:center;justify-content:center;
    background:var(--head-bg);color:var(--head-text);
    border-bottom:1px solid var(--grid-line);
    border-right:1px solid var(--grid-line);
    font-weight:700;font-size:14px;padding:0 8px;text-align:center;
  }
  .head.hour{justify-content:flex-start;padding-left:8px}

  /* Colonne HEURE (wrapper sur 96 lignes) */
  .hours-col{
    grid-column:1;
    grid-row:2 / span 96;
    position:relative;
    border-right:1px solid var(--grid-line);
  }
  .h-slot{
    position:absolute;left:0;right:0;height:var(--slot-h);
    border-top:1px solid rgba(0,0,0,.06);
    pointer-events:none;
  }
  .h-slot.hour-start{ border-top-color:#d8d8d8; }
.hour-label{
  position:absolute;
  left:8px;
  top:0;                 /* on place exactement sur la ligne de lâ€™heure */
  font-size:13px;
  font-weight:700;
  line-height:1;
  color:var(--hour-text);
  transform:none;        /* au cas oÃ¹ un cache traÃ®ne */
}

  /* Colonnes JOUR (wrapper sur 96 lignes) */
  .day-col{
    position: relative;
    grid-row: 2 / span 96;
    border-left:1px solid var(--grid-line);
  }
  .day-slot{
    position:absolute;left:0;right:0;height:var(--slot-h);
    border-top:1px solid rgba(0,0,0,.06);
    pointer-events:none;
  }
  .day-slot.hour-start{ border-top-color:#d8d8d8; }

  .day-col.drag-over{outline:2px dashed var(--postit);outline-offset:-2px}

  /* Post-it plus sobre */
/* Post-it : base neutre, pas de coin arrondi, pas de dÃ©bordement */
.postit{
  position:absolute;
  left:1px; right:1px; top:0;
  background:var(--postit);
  color:var(--postit-text);
  border:1px solid var(--postit-border);
  border-radius:0;

  display:flex; align-items:center; justify-content:center;

  /* pas de padding vertical -> respecte la hauteur exacte (8px par slot) */
  padding:0 2px;
  font-size:9px;         /* plus petit */
  font-weight:500;
  line-height:1;         /* clÃ© pour les 15 min */
  text-align:center;

  overflow:hidden;
  text-overflow:ellipsis;
  cursor:grab; user-select:none;
  z-index:2;
}

/* Cas 1 slot (15 min) : une seule ligne, jamais de wrap */
.postit[data-slots="1"]{
  white-space:nowrap;
}

/* Cas >= 2 slots : on autorise le retour Ã  la ligne dans le bloc */
.postit:not([data-slots="1"]){
  white-space:normal;    /* => wrap autorisÃ© */
  line-height:1.05;      /* un poil dâ€™air */
  padding:1px 3px;       /* lÃ©ger padding, reste dans la hauteur calculÃ©e */
  word-break:break-word; /* coupe proprement si nÃ©cessaire */
}

  /* Sidebar */
  .sidebar h2{font-size:16px;margin:0 0 8px;color:var(--head-text)}
  #emissions-pool{display:flex;flex-direction:column;gap:10px}
  #emissions-pool.drop-pool-hover{background:#fff8f8;border:2px dashed var(--postit);padding:10px;border-radius:6px}
  .emission-card{
    background:var(--postit);color:#fff;border:1px solid var(--postit-border);
    padding:6px 8px;border-radius:6px;font-size:12px;font-weight:700;cursor:grab;user-select:none
  }

  /* Tooltip custom (si tu veux revenir plus tard) */
  .custom-tooltip{
    position:fixed;display:none;background:rgba(0,0,0,.85);color:#fff;
    padding:4px 8px;border-radius:4px;font-size:12px;pointer-events:none;z-index:9999;
  }

  @media (max-width: 900px){ .grid-area{overflow-x:auto} }
  </style>
{% endblock %}
{% block body %}
  <h1>
    Grille de programmation
  </h1>
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
    <a href="{{ path('admin.grille.index', {'startOfWeek': startOfWeek|date_modify('-7 days')|date('Y-m-d')}) }}">
      â¬… Semaine prÃ©cÃ©dente
    </a>
    <h2 style="font-size:18px;margin:0;">
      <a href="{{ path('admin.grille.index') }}">
        ðŸ“… Semaine actuelle
      </a>
      Semaine du
      {{ startOfWeek|date('d/m/Y') }}
    </h2>
    <a href="{{ path('admin.grille.index', {'startOfWeek': startOfWeek|date_modify('+7 days')|date('Y-m-d')}) }}">
      Semaine suivante âž¡
    </a>
  </div>
  <div class="schedule-layout" data-controller="grid">
    <div class="grid-area">
      <div class="schedule-grid">
        {# Ligne dâ€™en-tÃªte #}
        <div class="head hour" style="grid-column:1;grid-row:1;">
          Heure
        </div>
        {% for i in 0..6 %}
          {% set jour = startOfWeek|date_modify("+" ~ i ~ " days") %}
          <div class="head" style="grid-column: {{ 2 + i }}; grid-row:1;">
            {{ jour|format_date('medium', locale='fr') }}
          </div>
        {% endfor %}
        {# Colonne HEURE : 96 quarts dâ€™heure + labels toutes les 4 lignes #}
        <div class="hours-col">
          {% for i in 0..95 %}
            <div class="h-slot {{ i % 4 == 0 ? 'hour-start' : '' }}" style="top: calc({{ i }} * var(--slot-h));"></div>
          {% endfor %}
          {% for h in 0..23 %}
            <div class="hour-label" style="top: calc({{ h*4 }} * var(--slot-h));">
              {{ "%02d:00"|format(h) }}
            </div>
          {% endfor %}
        </div>
        {# 7 colonnes JOUR #}
        {% for dayIndex in 0..6 %}
          <div class="day-col" data-grid-target="day" style="grid-column: {{ 2 + dayIndex }};">
            {# 96 quarts dâ€™heure = 24h * 4 #}
            {% for i in 0..95 %}
              <div class="day-slot {{ i % 4 == 0 ? 'hour-start' : '' }}" style="top: calc({{ i }} * var(--slot-h));"></div>
            {% endfor %}
            {# Post-its existants #}
            {% for seg in (daySegments[dayIndex] ?? []) %}
              {% set slots = (seg.duration / 15)|round(0, 'ceil') %}
              {% set h = (seg.startIndex // 4) %}
              {% set m = (seg.startIndex % 4) * 15 %}
              <div class="postit" style="top: calc({{ seg.startIndex }} * var(--slot-h));
              height: calc({{ slots }} * var(--slot-h));" data-slots="{{ slots }}" data-duration="{{ seg.duration }}" title="ðŸŽ™ {{ seg.title }} â€¢ {{ seg.duration }} min" {# tooltip natif #} draggable="true">
                ðŸŽ™
                {{ seg.title }}
                â€¢
                {{ seg.duration }}
                min
              </div>
            {% endfor %}
          </div>
        {% endfor %}
      </div>
    </div>
    <aside class="sidebar">
      <h2>
        Ã‰missions disponibles
      </h2>
      <div id="emissions-pool"></div>
    </aside>
  </div>
  <div id="tooltip" class="custom-tooltip"></div>
{% endblock %}
