# üß± STAGE 1 : build avec Composer
FROM php:8.3-cli as composer_build

RUN apt-get update && apt-get install -y \
    libicu-dev zip git unzip libzip-dev && \
    docker-php-ext-install intl pdo pdo_mysql zip && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

COPY --from=composer:2 /usr/bin/composer /usr/bin/composer

WORKDIR /app

# Copier tout le projet pour avoir bin/console, src/, etc.
COPY . .

RUN composer install

# üèÅ STAGE 2 : image de production
FROM php:8.3-apache

# D√©pendances syst√®me + extensions PHP
RUN apt-get update && apt-get install -y \
    libicu-dev zip git unzip libzip-dev && \
    docker-php-ext-install intl pdo pdo_mysql zip && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Active mod_rewrite
RUN a2enmod rewrite

# Cr√©e un utilisateur non-root
RUN addgroup --system app && adduser --system --ingroup app appuser

# D√©finir le dossier de travail
WORKDIR /var/www/html

# Copie du code source (tout sauf /vendor)
COPY . .

# Copie du dossier /vendor depuis le premier stage
COPY --from=composer_build /app/vendor ./vendor

# Copie du script d'entr√©e
COPY docker/entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# Droits
RUN chown -R appuser:app /var/www/html

USER appuser

# Dockerfile

# Copie la configuration apache personnalis√©e
COPY ./docker/apache/apache.conf /etc/apache2/sites-available/000-default.conf

# Active mod_rewrite (utile pour Symfony routing)
RUN a2enmod rewrite



ENTRYPOINT ["entrypoint.sh"]

CMD ["apache2-foreground"]
